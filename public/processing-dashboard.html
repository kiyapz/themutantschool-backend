<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Processing Dashboard</title>
  <style>
    :root {
      --primary-color: #3498db;
      --primary-dark: #2980b9;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #3498db;
      --light-bg: #f5f5f5;
      --card-bg: #ffffff;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f9f9f9;
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    h1, h2, h3 {
      color: var(--text-primary);
      margin-top: 0;
    }
    
    h1 {
      font-size: 28px;
      font-weight: 600;
    }
    
    h2 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 15px;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 25px;
    }
    
    @media (max-width: 992px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
    }
    
    .stats-card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stats-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    
    .stat-item {
      background-color: var(--light-bg);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    
    .stat-item:hover {
      transform: translateY(-2px);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .video-list {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--shadow);
      max-height: 800px;
      overflow-y: auto;
    }
    
    .video-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .video-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .filter-btn {
      padding: 6px 12px;
      background-color: var(--light-bg);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    .filter-btn.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .video-item {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-left: 4px solid transparent;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .video-item:hover {
      transform: translateX(3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .video-item.status-published {
      border-left-color: var(--success-color);
    }
    
    .video-item.status-processing {
      border-left-color: var(--warning-color);
    }
    
    .video-item.status-failed {
      border-left-color: var(--danger-color);
    }
    
    .video-item.status-uploaded {
      border-left-color: var(--info-color);
    }
    
    .video-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    
    .video-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .video-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 12px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .video-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .status-uploaded {
      background-color: var(--info-color);
      color: white;
    }
    
    .status-processing {
      background-color: var(--warning-color);
      color: white;
    }
    
    .status-processed {
      background-color: var(--success-color);
      color: white;
    }
    
    .status-published {
      background-color: var(--success-color);
      color: white;
    }
    
    .status-failed {
      background-color: var(--danger-color);
      color: white;
    }
    
    .video-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    button {
      padding: 8px 16px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background-color: var(--light-bg);
      color: var(--text-primary);
    }
    
    .btn-secondary:hover {
      background-color: #e0e0e0;
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #c0392b;
    }
    
    .refresh-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 20px;
    }
    
    .loading-indicator {
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-secondary);
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .progress-bar-container {
      height: 6px;
      background-color: var(--light-bg);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    .search-container {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    
    .search-input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .header-left {
      display: flex;
      flex-direction: column;
    }
    
    .subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 5px;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .last-updated {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .controls-container {
      margin-bottom: 20px;
    }
    
    .filter-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }
    
    .sort-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sort-select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .modal-content {
      background-color: white;
      margin: 50px auto;
      padding: 0;
      width: 80%;
      max-width: 800px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      animation: modalFadeIn 0.3s;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    .modal-body {
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .notification {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-radius: 6px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      width: 300px;
      background-color: white;
      animation: notificationFadeIn 0.3s;
    }
    
    @keyframes notificationFadeIn {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .notification.notification-hide {
      animation: notificationFadeOut 0.3s;
    }
    
    @keyframes notificationFadeOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(50px); }
    }
    
    .notification.success {
      border-left: 4px solid var(--success-color);
    }
    
    .notification.error {
      border-left: 4px solid var(--danger-color);
    }
    
    .notification.info {
      border-left: 4px solid var(--info-color);
    }
    
    .notification-icon {
      margin-right: 10px;
      display: flex;
      align-items: center;
    }
    
    .notification.success .notification-icon {
      color: var(--success-color);
    }
    
    .notification.error .notification-icon {
      color: var(--danger-color);
    }
    
    .notification.info .notification-icon {
      color: var(--info-color);
    }
    
    .notification-content {
      flex: 1;
      font-size: 14px;
    }
    
    .notification-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #999;
    }
    
    .system-info {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .system-time {
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>Video Processing Dashboard</h1>
      <span class="subtitle">Monitor and manage video processing tasks</span>
    </div>
    <div class="header-actions">
      <button id="uploadBtn" class="action-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Upload New Video
      </button>
      <button id="refreshBtn" class="action-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 4v6h-6"></path>
          <path d="M1 20v-6h6"></path>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
          <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        Refresh Data
      </button>
      <div class="system-info">
        <span>Current time:</span>
        <span class="system-time" id="currentTime">Monday, April 21, 2025, 7:16 AM IST</span>
      </div>
      <div class="last-updated">
        Last updated: <span id="lastUpdatedTime">-</span>
      </div>
    </div>
  </header>
  
  <div class="controls-container">
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Search videos by title or ID...">
      <button id="searchBtn" class="action-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        Search
      </button>
    </div>
    <div class="filter-container">
      <div class="video-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="published">Published</button>
        <button class="filter-btn" data-filter="processing">Processing</button>
        <button class="filter-btn" data-filter="uploaded">Uploaded</button>
        <button class="filter-btn" data-filter="failed">Failed</button>
      </div>
      <div class="sort-container">
        <label for="sortSelect">Sort by:</label>
        <select id="sortSelect" class="sort-select">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="title">Title (A-Z)</option>
          <option value="status">Status</option>
        </select>
      </div>
    </div>
  </div>
  
  <div class="dashboard">
    <div>
      <div class="stats-card">
        <h2>Queue Statistics</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="waitingCount">-</div>
            <div class="stat-label">Waiting</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="activeCount">-</div>
            <div class="stat-label">Active</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="completedCount">-</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="failedCount">-</div>
            <div class="stat-label">Failed</div>
          </div>
        </div>
      </div>
      
      <div class="stats-card">
        <h2>Video Statistics</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="totalVideos">-</div>
            <div class="stat-label">Total Videos</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="publishedVideos">-</div>
            <div class="stat-label">Published</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="processingVideos">-</div>
            <div class="stat-label">Processing</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="failedVideos">-</div>
            <div class="stat-label">Failed</div>
          </div>
        </div>
      </div>
      
      <div class="stats-card">
        <h2>System Health</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="cpuUsage">-</div>
            <div class="stat-label">CPU Usage</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="memoryUsage">-</div>
            <div class="stat-label">Memory Usage</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="diskUsage">-</div>
            <div class="stat-label">Disk Usage</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="networkUsage">-</div>
            <div class="stat-label">Network</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="video-list">
      <div class="video-list-header">
        <h2>Recent Videos</h2>
      </div>
      
      <div id="loadingIndicator" class="loading-indicator">
        <div class="spinner"></div>
        <span>Loading videos...</span>
      </div>
      
      <div id="videoItems"></div>
      
      <div id="emptyState" class="empty-state" style="display: none;">
        <p>No videos found matching your criteria.</p>
      </div>
    </div>
  </div>
  
  <!-- Video Details Modal -->
  <div id="videoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Video Details</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="loading-indicator">
          <div class="spinner"></div>
          <span>Loading video details...</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Upload Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upload New Video</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="uploadForm">
          <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" required />
          </div>
          
          <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description"></textarea>
          </div>
          
          <div class="form-group">
            <label for="video">Select Video:</label>
            <input type="file" id="video" name="video" accept="video/*" required />
            <div class="file-preview" id="filePreview"></div>
          </div>
          
          <div class="progress-container" style="display: none;">
            <div class="progress-bar-container">
              <div class="progress-bar" id="uploadProgressBar"></div>
            </div>
            <div class="progress-text" id="uploadProgressText">0%</div>
          </div>
          
          <div class="modal-actions">
            <button type="submit" class="action-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              Upload Video
            </button>
            <button type="button" class="action-btn btn-secondary cancel-btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    // State management
    const state = {
      videos: [],
      filteredVideos: [],
      queueStatus: {},
      systemHealth: {
        cpu: 0,
        memory: 0,
        disk: 0,
        network: 0
      },
      filter: 'all',
      sort: 'newest',
      search: '',
      lastUpdated: null,
      isLoading: false
    };
    
    // DOM Elements
    const elements = {
      waitingCount: document.getElementById('waitingCount'),
      activeCount: document.getElementById('activeCount'),
      completedCount: document.getElementById('completedCount'),
      failedCount: document.getElementById('failedCount'),
      totalVideos: document.getElementById('totalVideos'),
      publishedVideos: document.getElementById('publishedVideos'),
      processingVideos: document.getElementById('processingVideos'),
      failedVideos: document.getElementById('failedVideos'),
      videoItems: document.getElementById('videoItems'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      emptyState: document.getElementById('emptyState'),
      refreshBtn: document.getElementById('refreshBtn'),
      searchInput: document.getElementById('searchInput'),
      searchBtn: document.getElementById('searchBtn'),
      sortSelect: document.getElementById('sortSelect'),
      filterBtns: document.querySelectorAll('.filter-btn'),
      uploadBtn: document.getElementById('uploadBtn'),
      uploadModal: document.getElementById('uploadModal'),
      videoModal: document.getElementById('videoModal'),
      lastUpdatedTime: document.getElementById('lastUpdatedTime'),
      currentTime: document.getElementById('currentTime'),
      cpuUsage: document.getElementById('cpuUsage'),
      memoryUsage: document.getElementById('memoryUsage'),
      diskUsage: document.getElementById('diskUsage'),
      networkUsage: document.getElementById('networkUsage')
    };
    
    // Update last updated time
    function updateLastUpdatedTime() {
      state.lastUpdated = new Date();
      elements.lastUpdatedTime.textContent = state.lastUpdated.toLocaleTimeString();
    }
    
    // Fetch queue status
    async function fetchQueueStatus() {
      try {
        const response = await fetch('/api/v1/videos/queue/status');
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          state.queueStatus = data.data;
          updateQueueStatusUI();
        }
      } catch (error) {
        console.error('Error fetching queue status:', error);
        showNotification('Error fetching queue status', 'error');
      }
    }
    
    // Update queue status UI
    function updateQueueStatusUI() {
      elements.waitingCount.textContent = state.queueStatus.waiting || 0;
      elements.activeCount.textContent = state.queueStatus.active || 0;
      elements.completedCount.textContent = state.queueStatus.completed || 0;
      elements.failedCount.textContent = state.queueStatus.failed || 0;
    }
    
    // Fetch videos
    async function fetchVideos() {
      if (state.isLoading) return;
      
      state.isLoading = true;
      elements.loadingIndicator.style.display = 'flex';
      elements.videoItems.innerHTML = '';
      elements.emptyState.style.display = 'none';
      
      try {
        // Build query parameters
        const params = new URLSearchParams();
        params.append('limit', 20);
        
        if (state.search) {
          params.append('search', state.search);
        }
        
        const response = await fetch(`/api/v1/videos?${params.toString()}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          state.videos = data.data.videos || [];
          updateLastUpdatedTime();
          applyFiltersAndSort();
          renderVideos();
          updateStatistics();
        } else {
          showNotification(data.message || 'Failed to fetch videos', 'error');
        }
      } catch (error) {
        console.error('Error fetching videos:', error);
        showNotification('Error fetching videos. Please try again.', 'error');
      } finally {
        state.isLoading = false;
        elements.loadingIndicator.style.display = 'none';
      }
    }
    
    // Apply filters and sorting to videos
    function applyFiltersAndSort() {
      // Apply filters
      if (state.filter === 'all') {
        state.filteredVideos = [...state.videos];
      } else {
        state.filteredVideos = state.videos.filter(video => 
          video.status && video.status.toLowerCase() === state.filter
        );
      }
      
      // Apply search if present
      if (state.search) {
        const searchLower = state.search.toLowerCase();
        state.filteredVideos = state.filteredVideos.filter(video => 
          (video.title && video.title.toLowerCase().includes(searchLower)) ||
          (video.id && video.id.toLowerCase().includes(searchLower))
        );
      }
      
      // Apply sorting
      switch(state.sort) {
        case 'newest':
          state.filteredVideos.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
          break;
        case 'oldest':
          state.filteredVideos.sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0));
          break;
        case 'title':
          state.filteredVideos.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
          break;
        case 'status':
          state.filteredVideos.sort((a, b) => (a.status || '').localeCompare(b.status || ''));
          break;
      }
    }
    
    // Update statistics
    function updateStatistics() {
      let published = 0;
      let processing = 0;
      let failed = 0;
      
      state.videos.forEach(video => {
        if (video.status === 'PUBLISHED') published++;
        else if (video.status === 'PROCESSING') processing++;
        else if (video.status === 'FAILED') failed++;
      });
      
      elements.totalVideos.textContent = state.videos.length;
      elements.publishedVideos.textContent = published;
      elements.processingVideos.textContent = processing;
      elements.failedVideos.textContent = failed;
    }
    
    // Render videos
    function renderVideos() {
      elements.videoItems.innerHTML = '';
      
      if (state.filteredVideos.length === 0) {
        elements.emptyState.style.display = 'block';
        return;
      }
      
      state.filteredVideos.forEach(video => {
        const videoItem = document.createElement('div');
        videoItem.className = `video-item status-${(video.status || '').toLowerCase()}`;
        
        // Format creation date
        const createdDate = video.createdAt ? new Date(video.createdAt).toLocaleString() : 'Unknown';
        
        // Calculate processing time if available
        let processingTime = '';
        if (video.processingStats && video.processingStats.duration) {
          const duration = video.processingStats.duration;
          processingTime = duration < 60 
            ? `${Math.round(duration)}s` 
            : `${Math.round(duration / 60)}m ${Math.round(duration % 60)}s`;
        }
        
        videoItem.innerHTML = `
          <div class="video-header">
            <div class="video-title">${video.title || 'Untitled Video'}</div>
            <span class="video-status status-${(video.status || '').toLowerCase()}">${video.status || 'Unknown'}</span>
          </div>
          <div class="video-meta">
            <span>ID: ${video.id}</span>
            <span>Created: ${createdDate}</span>
            ${processingTime ? `<span>Processing Time: ${processingTime}</span>` : ''}
          </div>
          ${video.status === 'PROCESSING' ? `
            <div class="progress-bar-container">
              <div class="progress-bar" style="width: 60%"></div>
            </div>
          ` : ''}
          <div class="video-actions">
            <button onclick="viewVideo('${video.id}')">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              View
            </button>
            <button onclick="showVideoDetails('${video.id}')">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              Details
            </button>
            ${video.status === 'FAILED' || video.status === 'UPLOADED' ? `
              <button onclick="processVideo('${video.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Process
              </button>
            ` : ''}
          </div>
        `;
        
        elements.videoItems.appendChild(videoItem);
      });
    }
    
    // Process video
    async function processVideo(id) {
      try {
        // Show processing indicator
        const buttons = document.querySelectorAll(`button[onclick="processVideo('${id}')"]`);
        buttons.forEach(button => {
          button.disabled = true;
          button.innerHTML = `
            <div class="spinner" style="width: 12px; height: 12px; border-width: 2px;"></div>
            Processing...
          `;
        });
        
        const response = await fetch(`/api/v1/videos/${id}/process`, {
          method: 'POST'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          showNotification(`Video ${id} queued for processing`, 'success');
          // Refresh data after a short delay
          setTimeout(() => {
            fetchVideos();
            fetchQueueStatus();
          }, 1000);
        } else {
          throw new Error(data.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error processing video:', error);
        showNotification(`Error: ${error.message}`, 'error');
        
        // Reset buttons
        const buttons = document.querySelectorAll(`button[onclick="processVideo('${id}')"]`);
        buttons.forEach(button => {
          button.disabled = false;
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            Process
          `;
        });
      }
    }
    
    // View video
    function viewVideo(id) {
      window.open(`/api/v1/videos/${id}/stream`, '_blank');
    }
    
    // Show video details
    async function showVideoDetails(id) {
      const modal = document.getElementById('videoModal');
      const modalBody = document.getElementById('modalBody');
      const modalTitle = document.getElementById('modalTitle');
      
      // Show modal and loading indicator
      modal.style.display = 'block';
      modalBody.innerHTML = `
        <div class="loading-indicator" style="display: flex;">
          <div class="spinner"></div>
          <span>Loading video details...</span>
        </div>
      `;
      modalTitle.textContent = 'Loading Video Details...';
      
      try {
        const response = await fetch(`/api/v1/videos/${id}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          const video = data.data;
          modalTitle.textContent = video.title || 'Video Details';
          
          // Format dates
          const createdAt = video.createdAt ? new Date(video.createdAt).toLocaleString() : 'Unknown';
          const updatedAt = video.updatedAt ? new Date(video.updatedAt).toLocaleString() : 'Unknown';
          
          // Build history items
          let historyItems = '';
          if (video.history && video.history.length > 0) {
            historyItems = video.history.map(item => {
              const date = new Date(item.createdAt).toLocaleString();
              return `<li><strong>${item.status}</strong> - ${date}</li>`;
            }).join('');
          }
          
          // Build renditions items
          let renditionsItems = '';
          if (video.renditions && video.renditions.length > 0) {
            renditionsItems = video.renditions.map(item => {
              return `<li><strong>${item.name}</strong> - ${item.resolution}, ${item.videoBitrate}</li>`;
            }).join('');
          }
          
          modalBody.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div>
                <p><strong>ID:</strong> ${video.id}</p>
                <p><strong>Status:</strong> <span class="video-status status-${(video.status || '').toLowerCase()}">${video.status}</span></p>
                <p><strong>Created:</strong> ${createdAt}</p>
                <p><strong>Updated:</strong> ${updatedAt}</p>
                ${video.duration ? `<p><strong>Duration:</strong> ${formatDuration(video.duration)}</p>` : ''}
              </div>
              <div>
                ${video.resolution ? `
                  <p><strong>Resolution:</strong> ${video.resolution.width}x${video.resolution.height}</p>
                ` : ''}
                ${video.processingStats ? `
                  <p><strong>Processing Time:</strong> ${formatDuration(video.processingStats.duration || 0)}</p>
                  <p><strong>Processing Status:</strong> ${video.processingStats.success ? 'Success' : 'Failed'}</p>
                ` : ''}
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h3>File Paths</h3>
              <p><strong>Original:</strong> ${video.originalPath || 'N/A'}</p>
              <p><strong>Processed:</strong> ${video.processedPath || 'N/A'}</p>
              <p><strong>HLS:</strong> ${video.hlsPath || 'N/A'}</p>
              <p><strong>Thumbnail:</strong> ${video.thumbnailPath || 'N/A'}</p>
            </div>
            
            ${renditionsItems ? `
              <div style="margin-bottom: 20px;">
                <h3>Renditions</h3>
                <ul>${renditionsItems}</ul>
              </div>
            ` : ''}
            
            ${historyItems ? `
              <div>
                <h3>Processing History</h3>
                <ul>${historyItems}</ul>
              </div>
            ` : ''}
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
              <button onclick="viewVideo('${video.id}')">View Video</button>
              ${video.status === 'FAILED' || video.status === 'UPLOADED' ? `
                <button onclick="processVideo('${video.id}')">Process Video</button>
              ` : ''}
              <button class="btn-secondary" onclick="closeModal('videoModal')">Close</button>
            </div>
          `;
        } else {
          throw new Error(data.message || 'Failed to fetch video details');
        }
      } catch (error) {
        console.error('Error fetching video details:', error);
        modalBody.innerHTML = `
          <div style="color: #e74c3c; text-align: center; padding: 20px;">
            <p>Error loading video details: ${error.message}</p>
            <button class="btn-secondary" onclick="closeModal('videoModal')">Close</button>
          </div>
        `;
      }
    }
    
    // Show upload modal
    function showUploadModal() {
      document.getElementById('uploadModal').style.display = 'block';
      document.getElementById('uploadForm').reset();
      document.getElementById('filePreview').innerHTML = '';
    }
    
    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Preview selected video
    function previewVideo(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const preview = document.getElementById('filePreview');
      preview.innerHTML = '';
      
      // Show file info
      const fileInfo = document.createElement('div');
      fileInfo.className = 'file-info';
      fileInfo.innerHTML = `
        <p><strong>File:</strong> ${file.name}</p>
        <p><strong>Size:</strong> ${formatFileSize(file.size)}</p>
        <p><strong>Type:</strong> ${file.type}</p>
      `;
      preview.appendChild(fileInfo);
      
      // Create video preview if possible
      if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.className = 'video-preview';
        video.controls = true;
        video.width = 320;
        
        const source = document.createElement('source');
        source.src = URL.createObjectURL(file);
        source.type = file.type;
        
        video.appendChild(source);
        preview.appendChild(video);
      }
    }
    
    // Upload video
    async function uploadVideo(event) {
      event.preventDefault();
      
      const form = event.target;
      const title = form.title.value;
      const description = form.description.value;
      const videoFile = form.video.files[0];
      
      if (!title || !videoFile) {
        showNotification('Please provide a title and select a video file.', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('title', title);
      formData.append('description', description);
      formData.append('video', videoFile);
      
      // Show progress container
      const progressContainer = form.querySelector('.progress-container');
      progressContainer.style.display = 'block';
      const progressBar = document.getElementById('uploadProgressBar');
      const progressText = document.getElementById('uploadProgressText');
      
      try {
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percentComplete + '%';
            progressText.textContent = percentComplete + '%';
          }
        });
        
        // Handle response
        xhr.addEventListener('load', function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const response = JSON.parse(xhr.responseText);
              showNotification(`Video uploaded successfully!`, 'success');
              
              // Close modal
              closeModal('uploadModal');
              
              // Refresh videos
              fetchVideos();
              fetchQueueStatus();
            } catch (error) {
              console.error('JSON Parse Error:', error);
              showNotification('Error parsing server response', 'error');
            }
          } else {
            let errorMessage = 'Upload failed with status: ' + xhr.status;
            try {
              const response = JSON.parse(xhr.responseText);
              errorMessage = response.message || errorMessage;
            } catch (e) {
              // If response isn't JSON, use the raw text
              errorMessage = xhr.responseText || errorMessage;
            }
            showNotification(errorMessage, 'error');
          }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
          showNotification('Upload failed. Network error.', 'error');
        });
        
        // Send the request
        xhr.open('POST', '/api/v1/videos');
        xhr.send(formData);
      } catch (error) {
        showNotification(`Upload failed: ${error.message}`, 'error');
      }
    }
    
    // Fetch system health
    async function fetchSystemHealth() {
      try {
        const response = await fetch('/api/v1/system/health');
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          state.systemHealth = data.data;
          updateSystemHealthUI();
        }
      } catch (error) {
        console.error('Error fetching system health:', error);
      }
    }
    
    // Update system health UI
    function updateSystemHealthUI() {
      elements.cpuUsage.textContent = `${Math.round(state.systemHealth.cpu || 0)}%`;
      elements.memoryUsage.textContent = `${Math.round(state.systemHealth.memory || 0)}%`;
      elements.diskUsage.textContent = `${Math.round(state.systemHealth.disk || 0)}%`;
      elements.networkUsage.textContent = `${formatNetworkSpeed(state.systemHealth.network || 0)}`;
    }
    
    // Format duration in seconds to readable format
    function formatDuration(seconds) {
      if (!seconds) return '0s';
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      let result = '';
      if (hours > 0) result += `${hours}h `;
      if (minutes > 0 || hours > 0) result += `${minutes}m `;
      result += `${secs}s`;
      
      return result;
    }
    
    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Format network speed
    function formatNetworkSpeed(bytesPerSecond) {
      return formatFileSize(bytesPerSecond) + '/s';
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
      // Create notification container if it doesn't exist
      let container = document.getElementById('notificationContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'notificationContainer';
        container.className = 'notification-container';
        document.body.appendChild(container);
      }
      
      // Create notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // Add icon based on type
      let icon = '';
      switch(type) {
        case 'success':
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
          break;
        case 'error':
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
          break;
        default:
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
      }
      
      notification.innerHTML = `
        <div class="notification-icon">${icon}</div>
        <div class="notification-content">${message}</div>
        <button class="notification-close">&times;</button>
      `;
      
      // Add to container
      container.appendChild(notification);
      
      // Add event listener to close button
      notification.querySelector('.notification-close').addEventListener('click', () => {
        notification.classList.add('notification-hide');
        setTimeout(() => {
          container.removeChild(notification);
        }, 300);
      });
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (container.contains(notification)) {
          notification.classList.add('notification-hide');
          setTimeout(() => {
            if (container.contains(notification)) {
              container.removeChild(notification);
            }
          }, 300);
        }
      }, 5000);
    }
    
    // Initialize dashboard
    function initDashboard() {
      // Set current time
      elements.currentTime.textContent = new Date().toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true,
        timeZoneName: 'short'
      });
      
      // Update time every minute
      setInterval(() => {
        elements.currentTime.textContent = new Date().toLocaleString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          hour12: true,
          timeZoneName: 'short'
        });
      }, 60000);
      
      // Fetch initial data
      fetchVideos();
      fetchQueueStatus();
      fetchSystemHealth();
      updateLastUpdatedTime();
      
      // Set up event listeners
      elements.refreshBtn.addEventListener('click', () => {
        fetchVideos();
        fetchQueueStatus();
        fetchSystemHealth();
        showNotification('Data refreshed successfully', 'success');
      });
      
      elements.uploadBtn.addEventListener('click', showUploadModal);
      
      // Modal close buttons
      document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const modal = btn.closest('.modal');
          if (modal) modal.style.display = 'none';
        });
      });
      
      // Cancel upload button
      document.querySelector('.cancel-btn').addEventListener('click', () => {
        closeModal('uploadModal');
      });
      
      // Close modals when clicking outside
      window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      });
      
      // File preview
      document.getElementById('video').addEventListener('change', previewVideo);
      
      // Upload form
      document.getElementById('uploadForm').addEventListener('submit', uploadVideo);
      
      elements.searchBtn.addEventListener('click', () => {
        state.search = elements.searchInput.value.trim();
        fetchVideos();
      });
      
      elements.searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          state.search = e.target.value.trim();
          fetchVideos();
        }
      });
      
      elements.sortSelect.addEventListener('change', (e) => {
        state.sort = e.target.value;
        applyFiltersAndSort();
        renderVideos();
      });
      
      // Filter buttons
      elements.filterBtns.forEach(button => {
        button.addEventListener('click', () => {
          elements.filterBtns.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          state.filter = button.dataset.filter;
          applyFiltersAndSort();
          renderVideos();
        });
      });
      
      // Set up auto-refresh
      setInterval(() => {
        fetchVideos();
        fetchQueueStatus();
        fetchSystemHealth();
      }, 30000);
    }
    
    // Make functions available globally
    window.processVideo = processVideo;
    window.viewVideo = viewVideo;
    window.showVideoDetails = showVideoDetails;
    window.closeModal = closeModal;
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>
